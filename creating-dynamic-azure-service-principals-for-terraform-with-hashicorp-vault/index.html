<!doctype html><html lang=en-US><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://l480.github.io/images/favicon.png><title>Creating Dynamic Azure Service Principals for Terraform with HashiCorp Vault | Nico Schiering</title>
<meta name=title content="Creating Dynamic Azure Service Principals for Terraform with HashiCorp Vault"><meta name=description content="Everyone knows, static secrets are bad and regularly rotating them is a must. But what’s better then rotated static secrets? Right, dynamic access! And that’s were Vault from HashiCorp comes in.
What is Vault? Vault is a cloud native secret management solution from HashiCorp. It tightly controls access to secrets and encryption keys by authenticating against trusted sources of identity such as Active Directory, LDAP, Kubernetes, CloudFoundry, and cloud platforms. Vault enables fine grained authorization of which users and applications are permitted access to secrets and keys."><meta name=keywords content="azure,vault,"><meta property="og:title" content="Creating Dynamic Azure Service Principals for Terraform with HashiCorp Vault"><meta property="og:description" content="Everyone knows, static secrets are bad and regularly rotating them is a must. But what’s better then rotated static secrets? Right, dynamic access! And that’s were Vault from HashiCorp comes in.
What is Vault? Vault is a cloud native secret management solution from HashiCorp. It tightly controls access to secrets and encryption keys by authenticating against trusted sources of identity such as Active Directory, LDAP, Kubernetes, CloudFoundry, and cloud platforms. Vault enables fine grained authorization of which users and applications are permitted access to secrets and keys."><meta property="og:type" content="article"><meta property="og:url" content="https://l480.github.io/creating-dynamic-azure-service-principals-for-terraform-with-hashicorp-vault/"><meta property="og:image" content="https://l480.github.io/images/share.png"><meta property="article:section" content="blog"><meta property="article:published_time" content="2020-06-23T00:00:00+00:00"><meta property="article:modified_time" content="2020-06-23T00:00:00+00:00"><meta property="og:site_name" content="Nico Schiering"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://l480.github.io/images/share.png"><meta name=twitter:title content="Creating Dynamic Azure Service Principals for Terraform with HashiCorp Vault"><meta name=twitter:description content="Everyone knows, static secrets are bad and regularly rotating them is a must. But what’s better then rotated static secrets? Right, dynamic access! And that’s were Vault from HashiCorp comes in.
What is Vault? Vault is a cloud native secret management solution from HashiCorp. It tightly controls access to secrets and encryption keys by authenticating against trusted sources of identity such as Active Directory, LDAP, Kubernetes, CloudFoundry, and cloud platforms. Vault enables fine grained authorization of which users and applications are permitted access to secrets and keys."><meta itemprop=name content="Creating Dynamic Azure Service Principals for Terraform with HashiCorp Vault"><meta itemprop=description content="Everyone knows, static secrets are bad and regularly rotating them is a must. But what’s better then rotated static secrets? Right, dynamic access! And that’s were Vault from HashiCorp comes in.
What is Vault? Vault is a cloud native secret management solution from HashiCorp. It tightly controls access to secrets and encryption keys by authenticating against trusted sources of identity such as Active Directory, LDAP, Kubernetes, CloudFoundry, and cloud platforms. Vault enables fine grained authorization of which users and applications are permitted access to secrets and keys."><meta itemprop=datePublished content="2020-06-23T00:00:00+00:00"><meta itemprop=dateModified content="2020-06-23T00:00:00+00:00"><meta itemprop=wordCount content="791"><meta itemprop=image content="https://l480.github.io/images/share.png"><meta itemprop=keywords content="azure,vault,"><meta name=referrer content="no-referrer-when-downgrade"><style>body{font-family:Verdana,sans-serif;margin:auto;padding:20px;max-width:720px;text-align:left;background-color:#fff;word-wrap:break-word;overflow-wrap:break-word;line-height:1.5;color:#444}h1,h2,h3,h4,h5,h6,strong,b{color:#222}a{color:#3273dc}.title{text-decoration:none;border:0}.title span{font-weight:400}nav a{margin-right:10px}textarea{width:100%;font-size:16px}input{font-size:16px}content{line-height:1.6}table{width:100%}img{max-width:100%}code{padding:2px 5px;background-color:#f2f2f2}pre code{color:#222;display:block;padding:20px;white-space:pre-wrap;font-size:14px;overflow-x:auto}div.highlight pre{background-color:initial;color:initial}div.highlight code{background-color:unset;color:unset}blockquote{border-left:1px solid #999;color:#222;padding-left:20px;font-style:italic}footer{padding:25px;text-align:center}.helptext{color:#777;font-size:small}.errorlist{color:#eba613;font-size:small}ul.blog-posts{list-style-type:none;padding:unset}ul.blog-posts li{display:flex}ul.blog-posts li span{flex:0 0 130px}ul.blog-posts li a:visited{color:#8b6fcb}@media(prefers-color-scheme:dark){body{background-color:#333;color:#ddd}h1,h2,h3,h4,h5,h6,strong,b{color:#eee}a{color:#8cc2dd}code{background-color:#777}pre code{color:#ddd}blockquote{color:#ccc}textarea,input{background-color:#252525;color:#ddd}.helptext{color:#aaa}}</style></head><body><header><a href=/ class=title><h2>Nico Schiering</h2></a><nav><a href=/>Home</a>
<a href=/blog>Blog</a></nav></header><main><h1>Creating Dynamic Azure Service Principals for Terraform with HashiCorp Vault</h1><p><i><time datetime=2020-06-23 pubdate>23 Jun, 2020</time></i></p><content><p>Everyone knows, static secrets are bad and regularly rotating them is a must. But what’s better then rotated static secrets? Right, dynamic access! And that’s were Vault from HashiCorp comes in.</p><h2 id=what-is-vault>What is Vault?</h2><p>Vault is a cloud native secret management solution from HashiCorp. It tightly controls access to secrets and encryption keys by authenticating against trusted sources of identity such as Active Directory, LDAP, Kubernetes, CloudFoundry, and cloud platforms. Vault enables fine grained authorization of which users and applications are permitted access to secrets and keys.</p><h2 id=azure-secrets-engine>Azure Secrets Engine</h2><p>The Azure Secrets Engine dynamically generates Azure service principals along with role and group assignments. Vault roles can be mapped to one or more Azure roles, and optionally group assignments, providing a simple, flexible way to manage the permissions granted to generated service principals.</p><h2 id=installing-vault>Installing Vault</h2><p>Before you start, you need to install Vault. I’ve deployed the Vault <a href=https://github.com/hashicorp/vault-helm>Helm chart</a> on AKS. Check out the Vault <a href=https://www.vaultproject.io/docs/platform/k8s>documentation</a> for the best practices.</p><h2 id=creating-a-service-principal>Creating a Service Principal</h2><p>Vault needs a service principal to be able to create further dynamic service principals and assign them roles at subscription or resource level.</p><p>In my case, I want to let Vault create dynamic service principals with permissions on the entire subscription. Therefore I need to assign the Vault service principal the Owner role on my subscription.</p><p><img src=/dynamic-azure-service-principals1.png alt="Vault service principal with Owner role"></p><p>The Vault service principal is now able to do role assignments on the entire subscription. However, it&rsquo;s still not able to create and manage service principals. Therefore you need to grant the below Microsoft Graph API and Azure Active Directory Graph permissions to the Vault service principal.</p><p><img src=/dynamic-azure-service-principals2.png alt="Vault service principal API permissions"></p><p>If you want to automate this process, check out my blog post about <a href=https://blog.nico-schiering.de/granting-azure-ad-admin-consent-programmatically/>Granting Azure AD Admin Consent Programmatically</a>.</p><h2 id=configuring-vault>Configuring Vault</h2><p>Now you need to enable the Azure Secret Engine in Vault. Therefore execute the bellow command. Make sure to replace <strong>subscription_id</strong> and <strong>tenant_id</strong> with your information and <strong>client_id</strong> and <strong>client_secret</strong> with those of the Vault service principal.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vault write azure/config <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>subscription_id<span style=color:#f92672>=</span>7a5a1bab-6098-4a31-8ed0-b8987e9ddfbe <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>tenant_id<span style=color:#f92672>=</span>90ec3c4c-9eb8-4adf-b1d1-5396c5128450 <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>client_id<span style=color:#f92672>=</span>255ad937-cb27-4a44-8827-9108c350cc3e <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>client_secret<span style=color:#f92672>=</span>YrUEcF.NV8fN3~074s4opN.WZE~t81PY.R
</span></span></code></pre></div><h3 id=creating-a-role>Creating a Role</h3><p>Roles let you configure a set of Azure roles on a certain scope, along with a role-specific time to live (TTL), which indicates the maximum lifetime of the service principal. Vault will delete the service principal after the TTL has exceeded, if the service principal has not been revoked before.</p><p>My role will grant the Contributor role to the subscription NS MSDN and has a TTL of 1 hour.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vault write azure/roles/ns-msdn-contributor ttl<span style=color:#f92672>=</span>1h azure_roles<span style=color:#f92672>=</span>-<span style=color:#e6db74>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;role_name&#34;: &#34;Contributor&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;scope&#34;:  &#34;/subscriptions/7a5a1bab-6098-4a31-8ed0-b8987e9ddfbe&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span></code></pre></div><h3 id=creating-a-vault-policy>Creating a Vault Policy</h3><p>To grant a Vault user access to the role you need to create a Vault policy, which we assign to a user later.</p><p>This policy will grant permissions to the role ns-msdn-contributor. Paste the below HCL code to a file named vault-policy.hcl.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>path <span style=color:#e6db74>&#34;azure/creds/ns-msdn-contributor&#34;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  capabilities <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;read&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>path <span style=color:#e6db74>&#34;azure/config&#34;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  capabilities <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;read&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>path <span style=color:#e6db74>&#34;auth/token/create&#34;</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>  capabilities <span style=color:#f92672>=</span> <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;create&#34;</span>, <span style=color:#e6db74>&#34;read&#34;</span>, <span style=color:#e6db74>&#34;update&#34;</span>, <span style=color:#e6db74>&#34;list&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Then execute the below command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vault policy write ns-msdn-contributor vault-policy.hcl
</span></span></code></pre></div><h3 id=creating-a-vault-user>Creating a Vault User</h3><p>For my setup I use the userpass <a href=https://www.vaultproject.io/docs/auth/userpass>Auth Method</a>, which is an username/password based authentication against Vault.</p><p>To enable the userpass Auth Method execute the below command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vault auth enable userpass
</span></span></code></pre></div><p>To create a user called <strong>terraform</strong> with the password <strong>foo</strong> and the policy <strong>ns-msdn-contributor</strong>, execute the below command.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vault write auth/userpass/users/terraform<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    password<span style=color:#f92672>=</span>foo <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    policies<span style=color:#f92672>=</span>ns-msdn-contributor
</span></span></code></pre></div><h2 id=creating-a-dynamic-service-principal-through-terraform>Creating a Dynamic Service Principal through Terraform</h2><p>The below Terraform code will retrieve a dynamic service principal from Vault and use it to authenticate against the Azure Resource Manager to deploy a resource group named example.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;tenant_id&#34;</span> {
</span></span><span style=display:flex><span>  type <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;subscription_id&#34;</span> {
</span></span><span style=display:flex><span>  type <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;vault_username&#34;</span> {
</span></span><span style=display:flex><span>  type <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;vault_password&#34;</span> {
</span></span><span style=display:flex><span>  type <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;vault&#34;</span> {
</span></span><span style=display:flex><span>  address <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://vault.nicoo.org&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>auth_login</span> {
</span></span><span style=display:flex><span>    path <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>vault_username</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    parameters <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      password <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>vault_password</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;vault_azure_access_credentials&#34; &#34;creds&#34;</span> {
</span></span><span style=display:flex><span>  backend        <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;azure&#34;</span>
</span></span><span style=display:flex><span>  role           <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ns-msdn-contributor&#34;</span>
</span></span><span style=display:flex><span>  validate_creds <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;azurerm&#34;</span> {
</span></span><span style=display:flex><span>  disable_terraform_partner_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  version                      <span style=color:#f92672>=</span> &#34;<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>.<span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span><span style=display:flex><span>  tenant_id                    <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>tenant_id</span>
</span></span><span style=display:flex><span>  subscription_id              <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>subscription_id</span>
</span></span><span style=display:flex><span>  client_id                    <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>vault_azure_access_credentials</span>.<span style=color:#66d9ef>creds</span>.<span style=color:#66d9ef>client_id</span>
</span></span><span style=display:flex><span>  client_secret                <span style=color:#f92672>=</span> <span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>vault_azure_access_credentials</span>.<span style=color:#66d9ef>creds</span>.<span style=color:#66d9ef>client_secret</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>features</span> {}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_resource_group&#34; &#34;example&#34;</span> {
</span></span><span style=display:flex><span>  name     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;example&#34;</span>
</span></span><span style=display:flex><span>  location <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;West Europe&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>For var.vault_username use the below syntax.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>auth/userpass/login/terraform
</span></span></code></pre></div><p>During the terraform plan you can see one of the dynamic service principals in the role assignments of the subscription. This service principal was created by Vault and will be deleted by Vault once the deployment is done or the TTL has exceeded.</p><p><img src=/dynamic-azure-service-principals3.png alt="Dynamic service principal created through Terraform"></p><h2 id=creating-a-dynamic-service-principal-through-the-vault-cli>Creating a Dynamic Service Principal through the Vault CLI</h2><p>You can also create a dynamic service principal &ldquo;manually&rdquo; through the Vault CLI.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vault read azure/creds/ns-msdn-contributor
</span></span></code></pre></div><p><img src=/dynamic-azure-service-principals4.png alt="Dynamic service principal created through Vault CLI"></p><p>Check out the Vault documentation about <a href=https://www.vaultproject.io/docs/audit/file>auditing</a>, to get a full overview of which service is retrieving secrets from Vault.</p></content><p><a href=https://l480.github.io/blog/azure/>#azure</a>
<a href=https://l480.github.io/blog/vault/>#vault</a></p></main><footer></footer></body></html>